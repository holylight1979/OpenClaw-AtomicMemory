# 通用工作流引擎

> 本檔案為全域自動載入指令，適用於所有專案。
> 專案特有的知識（路徑、架構、約束）由各專案根目錄的 `CLAUDE.md` 定義。

---

## 一、文件骨架與知識庫（_AIDocs 體系）

### Session 啟動檢查（每次對話開始時執行）

**每個 session 的第一次互動前**，檢查當前專案根目錄是否有 `_AIDocs/` 目錄：

- **沒有 `_AIDocs/`** → 自動執行 `/init-project` skill（`~/.claude/commands/init-project.md`），為專案建立知識庫骨架與記憶工作流
- **已有 `_AIDocs/`** → 啟用下方「工作中維護規則」，正常工作

### 工作中維護規則

當專案**已有 `_AIDocs/`** 時，自動啟用以下規則：

1. **開工前必讀**：進行分析或修改前，先讀 `_AIDocs/_INDEX.md` 確認是否已有相關文件
2. **禁止憑記憶作業**：不確定的架構事實必須查文件或原始碼，禁止猜測
3. **活文件更新**：修改了核心結構、發現新認知、踩到陷阱時，必須更新對應 `_AIDocs/*.md` + `_CHANGELOG.md`
4. **新增文件時**：同步更新 `_AIDocs/_INDEX.md`

---

## 二、決策記憶系統

### 三層分類

| 類型 | 符號 | 說明 |
|------|------|------|
| **固化** | `[固]` | 跨多次對談確認的穩定決策，長期有效 |
| **觀察** | `[觀]` | 已決策但可能演化，每次觸及時確認狀態 |
| **臨時** | `[臨]` | 單次對談中的決策，下次觸及時主動確認是否仍適用 |

### 運作方式

- 決策記憶存放在各專案的 `memory/Extra_Efficiently_TokenSafe.md`
- 當使用者提出需求**可能關聯到已記錄的決策**時，主動簡短提及並確認
  - 例：「根據先前決策，X 方面暫不處理 — 這次也是同樣嗎？」
- 隨確認次數增加，觀察 → 固化、臨時 → 觀察/固化 或刪除
- 每次狀態變更記錄到演化日誌

### 記憶什麼

- 使用者明確說「記住」或「以後都這樣」→ 直接固化
- 使用者在選項中做了取捨（做 A 不做 B）→ 臨時，附上推測原因
- 反覆出現的偏好/模式 → 觀察，經確認後固化

---

## 三、工作結束主動同步

完成**有意義的程式碼修改**後（不是只讀取或分析），主動詢問：

> 「這次修改涉及 N 個檔案，要我同步更新 _CHANGELOG 和 MEMORY 嗎？」

確認後執行：
1. 在 `_AIDocs/_CHANGELOG.md` 追加變更記錄
2. 更新 `MEMORY.md` 中相關的事實/待辦
3. 若有新的決策，更新 `Extra_Efficiently_TokenSafe.md`

**不要等使用者提醒**，這是 AI 的主動責任。

---

## 四、風險分級框架

所有專案通用的分級概念（具體分級項目由各專案 CLAUDE.md 定義）：

| 風險等級 | 通用原則 |
|---------|---------|
| **低** | 讀檔、搜尋、分析、產出報告 → 確認路徑正確即可 |
| **中** | 新增檔案、修改非核心邏輯 → 先讀取相關檔案 |
| **高** | 修改核心業務邏輯 → 必須讀文件 + 原始碼，遵循 SOP |
| **極高** | 修改框架基類、共用定義 → 必須向使用者確認，列出影響範圍 |

---

## 五、對話管理

### 拆分指引

- 獨立子任務可安全新開對話（MEMORY.md 會自動載入）
- 拆分前確保：新發現已寫入 `_AIDocs/`、`_CHANGELOG.md` 已更新、重要事實已存入 MEMORY.md
- 有順序依賴的任務（分析 → 計畫 → 執行）應在同一對話完成

### 主動提醒開新 Session

當以下任一條件成立時，主動提醒使用者考慮開新 session：

- **Context 被系統壓縮過**（收到 compaction 通知或先前訊息摘要）
- **當前任務已告一段落**，且接下來的工作與前面無強順序依賴
- **對話已累積大量工具呼叫**，回應明顯變慢

提醒格式（簡短即可）：
> 「這個 session 已經蠻長了，建議開新 session 繼續。重要資訊已存入 MEMORY.md。」

提醒前確保：當前產出的新知識、決策、變更都已寫入 MEMORY.md / _AIDocs。

### Token 節省原則

- 已決策的事項不重複深入分析，但簡短提及讓使用者知道 AI 有記住
- 已有 `_AIDocs` 分析文件的內容，不重新掃描原始碼，直接引用文件
- 大量重複性修改，先修改 1-2 個確認模式正確，再批量執行

---

## 六、使用者核心偏好

- **輕量極簡**：偏好直接、低抽象的解法，不用不需要的框架
- **高可讀性**：一個檔案看完相關邏輯，不需跳轉多處
- **反對過度綁定**：框架層應薄，開發者要能理解底層
- **不自動產生文件**：不主動建立 README / 文件檔案，除非被要求
